Running FOCEX
==============

.. FOrce Constant EXtraction (FOCEX)
.. ---------------------------------

.. role:: raw-math(raw)
	:format: latex html
.. only:: html
	:math:`\\require{mediawiki-texvc}`

FOrce Constant Extraction (FOCEX) is a code to extract force constants from force-displacements data, the output of which can be used as input to the following codes.
The installation of FOCEX has to be done before using it and is given in section :ref:`focex-install`. This code, FOCEX (FOrce Constant EXtraction) included in ALADYN (Anharmonic LAttice DYNamics) employs the
force constant calculation, 2nd, 3rd and 4th order to be latter used for other thermodynamical properties. The installation of FOCEX is simple and just require the
fortran compiler.

An example of **Ge** is provided inside **FOCEX/example** which consists of the VASP calculation to generate force-displacement DFT data and FOCEX run. In this
calculation a single Ge atom in the 2x2x2 Ge supercell is displaced by 4% to evaluate the forces. The force-displacement data consists of ``POSCAR1`` and ``OUTCAR1`` file.
The ``POSCAR1`` is a POSCAR like file of the unperturbed (relaxed) structure of the crystal, in this example is 2x2x2 Ge crystal structure and is given below.

.. code-block:: python

  Ge8
  1.0
  11.5257244110         0.0000000000         0.0000000000
  0.0000000000        11.5257244110         0.0000000000
  0.0000000000         0.0000000000        11.5257244110
  64
  Cartesian
  2.881431103         0.000000000         2.881431103
  2.881431103         0.000000000         8.644293308
  2.881431103         5.762862206         2.881431103
  2.881431103         5.762862206         8.644293308
  8.644293308         0.000000000         2.881431103
  8.644293308         0.000000000         8.644293308
  8.644293308         5.762862206         2.881431103
  8.644293308         5.762862206         8.644293308
  1.440715551         1.440715551         1.440715551
  1.440715551         1.440715551         7.203577757
  1.440715551         7.203577757         1.440715551
  1.440715551         7.203577757         7.203577757
  7.203577757         1.440715551         1.440715551
  7.203577757         1.440715551         7.203577757
  7.203577757         7.203577757         1.440715551
  7.203577757         7.203577757         7.203577757
  2.881431103         2.881431103         0.000000000
  2.881431103         2.881431103         5.762862206
  2.881431103         8.644293308         0.000000000
  2.881431103         8.644293308         5.762862206
  8.644293308         2.881431103         0.000000000
  8.644293308         2.881431103         5.762862206
  8.644293308         8.644293308         0.000000000
  8.644293308         8.644293308         5.762862206
  1.440715551         4.322146654         4.322146654
  1.440715551         4.322146654        10.085008860
  1.440715551        10.085008860         4.322146654
  1.440715551        10.085008860        10.085008860
  7.203577757         4.322146654         4.322146654
  7.203577757         4.322146654        10.085008860
  7.203577757        10.085008860         4.322146654
  7.203577757        10.085008860        10.085008860
  0.000000000         0.000000000         0.000000000
  0.000000000         0.000000000         5.762862206
  0.000000000         5.762862206         0.000000000
  0.000000000         5.762862206         5.762862206
  5.762862206         0.000000000         0.000000000
  5.762862206         0.000000000         5.762862206
  5.762862206         5.762862206         0.000000000
  5.762862206         5.762862206         5.762862206
  4.322146654         1.440715551         4.322146654
  4.322146654         1.440715551        10.085008860
  4.322146654         7.203577757         4.322146654
  4.322146654         7.203577757        10.085008860
  10.085008860         1.440715551         4.322146654
  10.085008860         1.440715551        10.085008860
  10.085008860         7.203577757         4.322146654
  10.085008860         7.203577757        10.085008860
  0.000000000         2.881431103         2.881431103
  0.000000000         2.881431103         8.644293308
  0.000000000         8.644293308         2.881431103
  0.000000000         8.644293308         8.644293308
  5.762862206         2.881431103         2.881431103
  5.762862206         2.881431103         8.644293308
  5.762862206         8.644293308         2.881431103
  5.762862206         8.644293308         8.644293308
  4.322146654         4.322146654         1.440715551
  4.322146654         4.322146654         7.203577757
  4.322146654        10.085008860         1.440715551
  4.322146654        10.085008860         7.203577757
  10.085008860         4.322146654         1.440715551
  10.085008860         4.322146654         7.203577757
  10.085008860        10.085008860         1.440715551
  10.085008860        10.085008860         7.203577757

Here, only the type of atom is not present in ``POSCAR1`` as compared to that of vasp POSCAR file. Similarly, ``OUTCAR1`` is a force-displacement data format
accepted by FOCEX code and its format for example in the case of Ge is given below.

.. code-block:: python

  # POSITION      TOTAL FORCE
     1       -289.18629538 =t, Etot(eV)
   2.8929600000000000        0.0000000000000000        2.8814299999999999      -0.11758299999999999       -0.0000000000000000       -0.0000000000000000
   2.8814299999999999        0.0000000000000000        8.6442899999999998        4.9600000000000002E-004  -0.0000000000000000       -0.0000000000000000
   2.8814299999999999        5.7628599999999999        2.8814299999999999        4.9600000000000002E-004  -0.0000000000000000       -0.0000000000000000
   2.8814299999999999        5.7628599999999999        8.6442899999999998       -4.5640000000000003E-003  -0.0000000000000000       -0.0000000000000000
   8.6442899999999998        0.0000000000000000        2.8814299999999999        3.2899999999999997E-004  -0.0000000000000000       -0.0000000000000000
   8.6442899999999998        0.0000000000000000        8.6442899999999998       -1.5699999999999999E-004  -0.0000000000000000       -0.0000000000000000
   8.6442899999999998        5.7628599999999999        2.8814299999999999       -1.5699999999999999E-004  -0.0000000000000000       -0.0000000000000000
   8.6442899999999998        5.7628599999999999        8.6442899999999998        2.6699999999999998E-004  -0.0000000000000000       -0.0000000000000000
   1.4407200000000000        1.4407200000000000        1.4407200000000000        2.8677000000000001E-002  -1.9474999999999999E-002   1.9474999999999999E-002
   1.4407200000000000        1.4407200000000000        7.2035799999999997       -4.8099999999999998E-004  -7.1400000000000001E-004   3.2800000000000000E-004
   1.4407200000000000        7.2035799999999997        1.4407200000000000       -4.8099999999999998E-004  -3.2800000000000000E-004   7.1400000000000001E-004
   1.4407200000000000        7.2035799999999997        7.2035799999999997        2.4350000000000001E-003  -4.0000000000000003E-005   4.0000000000000003E-005
   7.2035799999999997        1.4407200000000000        1.4407200000000000       -1.8400000000000000E-004  -3.3000000000000000E-004   3.3000000000000000E-004
   7.2035799999999997        1.4407200000000000        7.2035799999999997        8.3999999999999995E-005  -4.3999999999999999E-005   3.4000000000000000E-005
   7.2035799999999997        7.2035799999999997        1.4407200000000000        8.3999999999999995E-005  -3.4000000000000000E-005   4.3999999999999999E-005
   7.2035799999999997        7.2035799999999997        7.2035799999999997       -2.1599999999999999E-004  -3.4400000000000001E-004   3.4400000000000001E-004
   2.8814299999999999        2.8814299999999999        0.0000000000000000       -4.0619999999999996E-003   7.2599999999999997E-004  -7.2599999999999997E-004
   2.8814299999999999        2.8814299999999999        5.7628599999999999       -4.0780000000000000E-003  -7.3099999999999999E-004  -7.3099999999999999E-004
   2.8814299999999999        8.6442899999999998        0.0000000000000000       -4.0780000000000000E-003   7.3099999999999999E-004   7.3099999999999999E-004
   2.8814299999999999        8.6442899999999998        5.7628599999999999       -4.0619999999999996E-003  -7.2599999999999997E-004   7.2599999999999997E-004
   8.6442899999999998        2.8814299999999999        0.0000000000000000        1.0700000000000000E-004   6.0000000000000002E-005  -6.0000000000000002E-005
   8.6442899999999998        2.8814299999999999        5.7628599999999999        1.0300000000000000E-004  -5.7000000000000003E-005  -5.7000000000000003E-005
   8.6442899999999998        8.6442899999999998        0.0000000000000000        1.0300000000000000E-004   5.7000000000000003E-005   5.7000000000000003E-005
   8.6442899999999998        8.6442899999999998        5.7628599999999999        1.0700000000000000E-004  -6.0000000000000002E-005   6.0000000000000002E-005
   1.4407200000000000        4.3221499999999997        4.3221499999999997       -4.8099999999999998E-004   3.2800000000000000E-004  -7.1400000000000001E-004
   1.4407200000000000        4.3221499999999997        10.085010000000000        2.4350000000000001E-003   4.0000000000000003E-005  -4.0000000000000003E-005
   1.4407200000000000        10.085010000000000        4.3221499999999997        2.8677000000000001E-002   1.9474999999999999E-002  -1.9474999999999999E-002
   1.4407200000000000        10.085010000000000        10.085010000000000       -4.8099999999999998E-004   7.1400000000000001E-004  -3.2800000000000000E-004
   7.2035799999999997        4.3221499999999997        4.3221499999999997        8.3999999999999995E-005   3.4000000000000000E-005  -4.3999999999999999E-005
   7.2035799999999997        4.3221499999999997        10.085010000000000       -2.1599999999999999E-004   3.4400000000000001E-004  -3.4400000000000001E-004
   7.2035799999999997        10.085010000000000        4.3221499999999997       -1.8400000000000000E-004   3.3000000000000000E-004  -3.3000000000000000E-004
   7.2035799999999997        10.085010000000000        10.085010000000000        8.3999999999999995E-005   4.3999999999999999E-005  -3.4000000000000000E-005
   0.0000000000000000        0.0000000000000000        0.0000000000000000        1.6290000000000000E-003  -7.2499999999999995E-004   1.4820000000000000E-003
   0.0000000000000000        0.0000000000000000        5.7628599999999999        1.6290000000000000E-003   7.2499999999999995E-004  -1.4820000000000000E-003
   0.0000000000000000        5.7628599999999999        0.0000000000000000        4.2000000000000002E-004  -5.8000000000000000E-005  -8.8500000000000004E-004
   0.0000000000000000        5.7628599999999999        5.7628599999999999        4.2000000000000002E-004   5.8000000000000000E-005   8.8500000000000004E-004
   5.7628599999999999        0.0000000000000000        0.0000000000000000        1.6550000000000000E-003  -7.3399999999999995E-004  -1.5030000000000000E-003
   5.7628599999999999        0.0000000000000000        5.7628599999999999        1.6550000000000000E-003   7.3399999999999995E-004   1.5030000000000000E-003
   5.7628599999999999        5.7628599999999999        0.0000000000000000        4.2000000000000002E-004  -5.7000000000000003E-005   8.8000000000000003E-004
   5.7628599999999999        5.7628599999999999        5.7628599999999999        4.2000000000000002E-004   5.7000000000000003E-005  -8.8000000000000003E-004
   4.3221499999999997        1.4407200000000000        4.3221499999999997        2.8958999999999999E-002   2.0014000000000001E-002   2.0014000000000001E-002
   4.3221499999999997        1.4407200000000000        10.085010000000000       -4.8400000000000000E-004   7.0799999999999997E-004   3.3000000000000000E-004
   4.3221499999999997        7.2035799999999997        4.3221499999999997       -4.8400000000000000E-004   3.3000000000000000E-004   7.0799999999999997E-004
   4.3221499999999997        7.2035799999999997        10.085010000000000        2.4480000000000001E-003   4.0000000000000003E-005   4.0000000000000003E-005
   10.085010000000000        1.4407200000000000        4.3221499999999997       -1.8000000000000001E-004   3.2899999999999997E-004   3.2899999999999997E-004
   10.085010000000000        1.4407200000000000        10.085010000000000        7.7999999999999999E-005   3.4999999999999997E-005   2.8000000000000000E-005
   10.085010000000000        7.2035799999999997        4.3221499999999997        7.7999999999999999E-005   2.8000000000000000E-005   3.4999999999999997E-005
   10.085010000000000        7.2035799999999997        10.085010000000000       -2.1200000000000000E-004   3.4699999999999998E-004   3.4699999999999998E-004
   0.0000000000000000        2.8814299999999999        2.8814299999999999        1.6290000000000000E-003  -1.4820000000000000E-003   7.2499999999999995E-004
   0.0000000000000000        2.8814299999999999        8.6442899999999998        4.2000000000000002E-004   8.8500000000000004E-004   5.8000000000000000E-005
   0.0000000000000000        8.6442899999999998        2.8814299999999999        1.6290000000000000E-003   1.4820000000000000E-003  -7.2499999999999995E-004
   0.0000000000000000        8.6442899999999998        8.6442899999999998        4.2000000000000002E-004  -8.8500000000000004E-004  -5.8000000000000000E-005
   5.7628599999999999        2.8814299999999999        2.8814299999999999        1.6550000000000000E-003   1.5030000000000000E-003   7.3399999999999995E-004
   5.7628599999999999        2.8814299999999999        8.6442899999999998        4.2000000000000002E-004  -8.8000000000000003E-004   5.7000000000000003E-005
   5.7628599999999999        8.6442899999999998        2.8814299999999999        1.6550000000000000E-003  -1.5030000000000000E-003  -7.3399999999999995E-004
   5.7628599999999999        8.6442899999999998        8.6442899999999998        4.2000000000000002E-004   8.8000000000000003E-004  -5.7000000000000003E-005
   4.3221499999999997        4.3221499999999997        1.4407200000000000       -4.8400000000000000E-004  -3.3000000000000000E-004  -7.0799999999999997E-004
   4.3221499999999997        4.3221499999999997        7.2035799999999997        2.4480000000000001E-003  -4.0000000000000003E-005  -4.0000000000000003E-005
   4.3221499999999997        10.085010000000000        1.4407200000000000        2.8958999999999999E-002  -2.0014000000000001E-002  -2.0014000000000001E-002
   4.3221499999999997        10.085010000000000        7.2035799999999997       -4.8400000000000000E-004  -7.0799999999999997E-004  -3.3000000000000000E-004
   10.085010000000000        4.3221499999999997        1.4407200000000000        7.7999999999999999E-005  -2.8000000000000000E-005  -3.4999999999999997E-005
   10.085010000000000        4.3221499999999997        7.2035799999999997       -2.1200000000000000E-004  -3.4699999999999998E-004  -3.4699999999999998E-004
   10.085010000000000        10.085010000000000        1.4407200000000000       -1.8000000000000001E-004  -3.2899999999999997E-004  -3.2899999999999997E-004
   10.085010000000000        10.085010000000000        7.2035799999999997        7.7999999999999999E-005  -3.4999999999999997E-005  -2.8000000000000000E-005

The first line in ``OUTCAR1`` is the header for position and force for each atom in :math:`x`, :math:`y` and :math:`z` direction. The second line
consists of the energy of structure in electron volt and the lines after second are positions (first three columns, :math:`x`, :math:`y` and :math:`z`) and forces
(the last three columns :math:`F_x`, :math:`F_y` and :math:`F_z` are in :math:`eV/{\\A}`) respectively. If there are many force-displacement snapshots of the structure, then the ``OUTCAR1``
file repeat for itself. For the input file of FOCEX, the ``structure.params`` is given below

.. code-block:: python

  1 1 1 90 90 90          # a, b, c, alpha, beta, gamma
  0 .5 .5 .5 0 .5 .5 .5 0 # reduced coordinates of primitive lattice
  5.7628622055            # scale factor for lattice size
  1 1 1 1                 # include FC1234, 1st, 2nd, third and fourth order harmonic force constant(s), 1 is to include and 0 is to not include
  1 1 0 0                 # invariances to impose, (translational, rotational, Huang) last is enforce inv using elimination
  0 300                   # temperature and whether or not implement it (do not implement if 0,2, or ..)
  1 .true.                # number  of OUTCAR files, verbosity
  1                       # type of atoms
  72.64                   # masses of each type of atoms
  Ge                      # names of atom
  2                       # number of atoms in the primitive cell
  1                       # flag for setting the range of FC2s (if 0 take default; else use below)
  5 5                     # number of shells for rank 2 (harmonic) for each atom if not default
  1 1                     # number of shells for rank 3 (cubic) for each atom
  1 1                     # number of shells for rank 4 (quartic) for each atom
  1 1 0 0 0               # number of atom, type of atom, position x, position y, position z
  2 1 0.25 0.25 0.25      # number of atom, type of atom, position x, position y, position z

The fitting is done using singular value decomposition based on the ``POSCAR1`` and ``OUTCAR1`` i.e. by creating the force displacement matrix. Based on the position difference from ``POSCAR1`` and ``OUTCAR1`` file, the harmonic, cubic and quartic displacement are created for each of the atomic position (x,y,z). Further, if symmetry is turned on the displacements are added on top of it. Forces from the ``OUTCAR1`` file is appended to the last column of this force displacement matrix. The snippet showing force displacement matrix, ``amatrx.dat`` in this code is given below:

.. code-block:: python

  **********************************************
  Force-displ constraints part of amatrix size is          192
  **********************************************
  before call to svd, amat and bmat are:
   1.0       4.0       0.0       8.0       0.0       0.0       4.0       4.0       2.0       4.0       0.0       8.0       0.0       8.0       0.0       0.0       4.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0    
   0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       1.0       0.0       0.0       0.0       4.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0    
   0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       1.0      -1.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0    
   0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       1.0       0.0       4.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0    
   0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       1.0       0.0       0.0       4.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0    
   0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       1.0       0.0       0.0       0.0       0.0       0.0       1.0       0.0       0.0       0.0       0.0       0.0       0.0    

Here, in the first line provides the information for number of force displacement point. For example in the example taken here here for ``2x2x2`` supercell of `Ge`, the number ``192`` refers ``3*number of atoms in a supercell``. The number will increase accordingly if there are more than one snapshot in the ``POSCAR1`` file. Three lines below ``before call to svd: amat, bmat are:`` are the lines due to translation symmetry since only translation symmetry is turned on ``structure.params`` file. The remaining lines are each atomic displacements in a supercell of the given snapshot. Last column in all the line represent the force value from the ``OUTCAR1`` and all remaining columns are harmonic, cubic and quartic displacements.      

Similarly other input file ``dielectric.params`` is required to get the phonon dispersion and thermal conductivity using ``THERMACOND``. It consists of dielectric constant tensor values which is written as follows in the example folder inside ``FOCEX``

.. code-block:: python

 2.5078 0.0  0.0 # for example, dielectric constant of Ge
  0.0 2.5078 0.0
  0.0 0.0 2.5078

Now, if the ``POSCAR1``, ``OUTCAR1`` and ``structure.params`` are in same directory, simply run ``./focex.x`` within that directory to run FOCEX. After successful
run ``fc2.dat``, ``fc2_irr.dat``, ``fc3.dat``, ``fc3_irr.dat``, ``fc4.dat`` and ``fc4_irr.dat`` along with other output files and log file should be available. ``fc2.dat``, ``fc2_irr.dat`` are the fitted second order force constant and with symmetry reduced second order force constant. Similarly ``fc3.dat``, ``fc3_irr.dat`` and ``fc4.dat``, ``fc4_irr.dat`` are third order and fourth order force constant and symmetry reduced third order and fourth order force constant respectively. Users are advised to look for more information on the log file ``log.dat`` generated by ``fcborn_3.x``.
 
